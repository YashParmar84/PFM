{% extends 'base.html' %}

{% block title %}Budget Prediction - Personal Finance Management{% endblock %}

{% block extra_scripts %}
<script>
// Make functions globally accessible
window.loadBudgetPrediction = loadBudgetPrediction;
window.applyBudgetRecommendation = applyBudgetRecommendation;

async function loadBudgetPrediction() {
    const salaryInput = document.getElementById('salary-input');
    const predictionResult = document.getElementById('prediction-result');
    const loadingDiv = document.getElementById('prediction-loading');

    const salary = salaryInput.value.trim();

    if (!salary || isNaN(salary) || parseFloat(salary) <= 0) {
        alert('Please enter a valid salary amount');
        return;
    }

    // Show loading
    loadingDiv.style.display = 'block';
    predictionResult.style.display = 'none';

    try {
        const response = await fetch(`/user/api/budget-prediction/?salary=${encodeURIComponent(salary)}`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        renderBudgetPrediction(data);

        // Show result
        loadingDiv.style.display = 'none';
        predictionResult.style.display = 'block';

    } catch (error) {
        console.error('Error loading budget prediction:', error);
        loadingDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                Unable to generate budget prediction. Please try again later.
                <br><small class="text-muted">Error: ${error.message}</small>
            </div>
        `;
    }
}

function renderBudgetPrediction(data) {
    const resultDiv = document.getElementById('prediction-result');

    let html = `
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5><i class="fas fa-chart-line"></i> Budget Analysis for ‚Çπ${parseFloat(data.salary || 0).toLocaleString()}</h5>
                    <p class="mb-0">
                        Analysis Type: <strong>${data.analysis_type === 'personalized_historical' ? 'Based on your spending history' : 'Standard financial ratios'}</strong>
                        ${data.analysis_type === 'personalized_historical' ? `(${data.months_analyzed} months analyzed)` : ''}
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Summary Cards -->
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h4 class="card-title">üí∞ Savings</h4>
                        <h3>‚Çπ${parseFloat(data.savings_amount).toLocaleString()}</h3>
                        <p class="mb-0">${parseFloat(data.savings_percentage).toFixed(1)}% of salary</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h4 class="card-title">üìä Total Budget</h4>
                        <h3>‚Çπ${parseFloat(data.total_budgeted).toLocaleString()}</h3>
                        <p class="mb-0">For expenses</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h4 class="card-title">üìà Analysis</h4>
                        <h3>${data.analysis_type === 'personalized_historical' ? 'Personal' : 'Standard'}</h3>
                        <p class="mb-0">Recommendation</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Breakdown -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Recommended Budget Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Recommended Amount</th>
                                        <th>Percentage</th>
                                        <th>Priority</th>
                                        ${data.analysis_type === 'personalized_historical' ? '<th>Historical Avg</th>' : ''}
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
    `;

    data.budget_breakdown.forEach(item => {
        const badgeClass = item.priority <= 3 ? 'success' : item.priority <= 5 ? 'warning' : 'info';
        const typeIcon = item.type === 'needs' ? 'üõ°Ô∏è' : 'üéØ';

        html += `
            <tr>
                <td>
                    <strong>${typeIcon} ${item.category_display}</strong>
                    <br><small class="text-muted">${item.type} ‚Ä¢ Priority ${item.priority}</small>
                </td>
                <td>
                    <strong>‚Çπ${parseFloat(item.suggested_amount).toLocaleString()}</strong>
                </td>
                <td>
                    <span class="badge bg-${badgeClass}">${item.percentage}%</span>
                </td>
                <td>
                    <span class="badge bg-${badgeClass}">P${item.priority}</span>
                </td>
                ${data.analysis_type === 'personalized_historical' ? `
                <td>
                    ‚Çπ${parseFloat(item.historical_avg).toLocaleString()}
                    <br><small class="text-${item.adjustment === 'increased' ? 'success' : 'danger'}">
                        ${item.adjustment === 'increased' ? '‚Üó' : '‚Üò'} ${item.adjustment}
                    </small>
                </td>
                ` : ''}
                <td>
                    <button class="btn btn-sm btn-outline-primary"
                            onclick="applyBudgetRecommendation('${item.category}', ${item.suggested_amount})">
                        <i class="fas fa-plus"></i> Apply
                    </button>
                </td>
            </tr>
        `;
    });

    html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Personalized Recommendations</h5>
                    </div>
                    <div class="card-body">
    `;

    data.recommendations.forEach((recommendation, index) => {
        const icon = recommendation.includes('Warning') ? '‚ö†Ô∏è' :
                   recommendation.includes('Great') ? '‚úÖ' : 'üí°';

        html += `
            <div class="alert alert-${recommendation.includes('Warning') ? 'warning' : 'info'} mb-2">
                <strong>${icon} ${recommendation}</strong>
            </div>
        `;
    });

    html += `
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-success btn-lg w-100 mb-2" onclick="applyAllRecommendations()">
                                    <i class="fas fa-check-double"></i> Apply All Recommendations
                                </button>
                            </div>
                            <div class="col-md-6">
                                <a href="{% url 'user:budget_management' %}" class="btn btn-primary btn-lg w-100 mb-2">
                                    <i class="fas fa-cog"></i> Manage Existing Budgets
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function applyBudgetRecommendation(category, amount) {
    // Redirect to budget management with pre-filled data
    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
    window.location.href = `/user/budget/?category=${category}&amount=${amount}&month=${currentMonth}`;
}

function applyAllRecommendations() {
    // This would apply all budget recommendations at once
    // For now, redirect to budget management
    const currentMonth = new Date().toISOString().slice(0, 7);
    window.location.href = `/user/budget/?bulk_apply=true&month=${currentMonth}`;
}
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-crystal-ball"></i> AI Budget Prediction
        </h1>
        <p class="lead">Get personalized budget recommendations based on your salary and spending history</p>
    </div>
</div>

<!-- Salary Input Section -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Enter Your Monthly Salary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">‚Çπ</span>
                            <input type="number"
                                   class="form-control"
                                   id="salary-input"
                                   placeholder="Enter your monthly salary (e.g., 20000)"
                                   min="1"
                                   step="1000">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary btn-lg w-100" onclick="loadBudgetPrediction()">
                            <i class="fas fa-search"></i> Generate Budget
                        </button>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Enter your monthly salary to get AI-powered budget recommendations based on standard financial ratios and your spending history.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Examples -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Quick Examples</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('salary-input').value='20000'">
                        ‚Çπ20,000
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('salary-input').value='50000'">
                        ‚Çπ50,000
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('salary-input').value='100000'">
                        ‚Çπ1,00,000
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="prediction-loading" class="text-center py-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Analyzing your data and generating budget recommendations...</p>
</div>

<!-- Prediction Results -->
<div id="prediction-result" style="display: none;">
    <!-- Results will be populated by JavaScript -->
</div>

<!-- Features Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-star"></i> Features</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="mb-3">
                            <i class="fas fa-brain fa-3x text-primary"></i>
                        </div>
                        <h6>AI-Powered Analysis</h6>
                        <p class="text-muted">Advanced algorithms analyze your spending patterns to create personalized recommendations</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="mb-3">
                            <i class="fas fa-chart-line fa-3x text-success"></i>
                        </div>
                        <h6>Historical Data</h6>
                        <p class="text-muted">Uses your actual spending history for more accurate budget predictions</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="mb-3">
                            <i class="fas fa-piggy-bank fa-3x text-warning"></i>
                        </div>
                        <h6>Smart Savings</h6>
                        <p class="text-muted">Automatically calculates optimal savings amount based on your income and expenses</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <a href="{% url 'user:dashboard' %}" class="btn btn-secondary btn-lg w-100 mb-2">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'user:add_transaction' %}" class="btn btn-success btn-lg w-100 mb-2">
                            <i class="fas fa-plus"></i> Add Transaction
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'user:budget_management' %}" class="btn btn-info btn-lg w-100 mb-2">
                            <i class="fas fa-chart-pie"></i> Manage Budget
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'user:transaction_list' %}" class="btn btn-primary btn-lg w-100 mb-2">
                            <i class="fas fa-list"></i> View Transactions
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
