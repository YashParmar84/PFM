{% extends 'base.html' %}

{% block title %}Dashboard - Personal Finance Management{% endblock %}

{% block extra_scripts %}
<script>
// Make functions globally accessible
window.loadBudgetSuggestions = loadBudgetSuggestions;
window.loadAIInsights = loadAIInsights;
window.renderSpendingChart = renderSpendingChart;
window.renderBudgetSuggestions = renderBudgetSuggestions;
window.applySuggestion = applySuggestion;

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load AI insights on page load
    loadAIInsights();
});

// AI Insights Functions
async function loadAIInsights() {
    const loadingDiv = document.getElementById('ai-loading');
    const contentDiv = document.getElementById('ai-insights-content');

    loadingDiv.style.display = 'block';
    contentDiv.style.display = 'none';

    try {
        // Load comprehensive chart data for the default chart type
        await loadMainChart();

        // Show content
        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';

    } catch (error) {
        console.error('Error loading AI insights:', error);
        loadingDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                Unable to load AI insights. Please try again later.
            </div>
        `;
    }
}

async function loadBudgetSuggestions() {
    const suggestionsDiv = document.getElementById('budget-suggestions');

    // Show loading state
    suggestionsDiv.innerHTML = `
        <div class="col-12 text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Generating budget suggestions...</p>
        </div>
    `;

    try {
        const response = await fetch('/user/api/budget-suggestions/');
        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        // Check if we have suggestions or a message
        if (data.suggestions && data.suggestions.length > 0) {
            renderBudgetSuggestions(data.suggestions);
        } else {
            // Show message if no suggestions available
            suggestionsDiv.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        ${data.message || 'No specific suggestions at this time. Your budget looks well-optimized!'}
                    </div>
                </div>
            `;
        }

    } catch (error) {
        console.error('Error loading budget suggestions:', error);
        suggestionsDiv.innerHTML = `
            <div class="col-12">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Unable to load budget suggestions. Please try again later.
                    <br><small class="text-muted">Error: ${error.message}</small>
                </div>
            </div>
        `;
    }
}

function renderSpendingChart(categoryAnalysis) {
    const ctx = document.getElementById('spendingChart').getContext('2d');

    // Destroy existing chart if it exists
    if (window.spendingChart && typeof window.spendingChart.destroy === 'function') {
        window.spendingChart.destroy();
    }

    if (!categoryAnalysis || categoryAnalysis.length === 0) {
        document.getElementById('spendingChart').style.display = 'none';
        return;
    }

    // Prepare data for chart
    const labels = categoryAnalysis.map(item => item.category_display);
    const data = categoryAnalysis.map(item => parseFloat(item.total_amount));
    const backgroundColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
    ];

    window.spendingChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const value = context.parsed || 0;
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${context.label}: â‚¹${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}



function renderBudgetSuggestions(suggestions) {
    const suggestionsDiv = document.getElementById('budget-suggestions');

    if (!suggestions || suggestions.length === 0) {
        suggestionsDiv.innerHTML = `
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No specific suggestions at this time. Your budget looks well-optimized!
                </div>
            </div>
        `;
        return;
    }

    let suggestionsHtml = '';
    suggestions.slice(0, 4).forEach((suggestion, index) => {  // Show top 4 suggestions
        const badgeColor = suggestion.type === 'increase' ? 'warning' :
                          suggestion.type === 'decrease' ? 'success' : 'primary';

        const icon = suggestion.type === 'increase' ? 'arrow-up' :
                    suggestion.type === 'decrease' ? 'arrow-down' : 'plus';

        suggestionsHtml += `
            <div class="col-md-6 mb-3">
                <div class="card border-${badgeColor}">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-3">
                                <span class="badge bg-${badgeColor}">
                                    <i class="fas fa-${icon}"></i>
                                </span>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${suggestion.category}</h6>
                                <p class="mb-2 text-sm">${suggestion.reason}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        Confidence: ${suggestion.confidence}%
                                    </small>
                                    <button class="btn btn-sm btn-outline-${badgeColor}"
                                            onclick="applySuggestion('${suggestion.category}', ${suggestion.suggested_budget})">
                                        Apply
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    suggestionsDiv.innerHTML = suggestionsHtml;
}

function applySuggestion(category, suggestedAmount) {
    // Redirect to budget management with pre-filled data
    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
    window.location.href = `/user/budget/?category=${encodeURIComponent(category)}&amount=${suggestedAmount}&month=${currentMonth}&source=dashboard`;
}

// Chart type and date range variables
let currentMainChartType = 'spending_breakdown';
let currentMainDateRange = 'last_12_months';

// Main chart type change handler
function onMainChartTypeChange() {
    currentMainChartType = document.getElementById('mainChartTypeSelect').value;
    updateMainChartSummary();
}

// Main date range change handler
function onMainDateRangeChange() {
    currentMainDateRange = document.getElementById('mainDateRangeSelect').value;
    updateMainChartSummary();
}

// Update main chart summary text
function updateMainChartSummary() {
    const chartTypeText = getChartTypeDisplayName(currentMainChartType);
    const dateRangeText = getDateRangeDisplayName(currentMainDateRange);

    document.getElementById('mainChartSummary').textContent = `Showing ${chartTypeText} for ${dateRangeText}`;
}

// Get display name for chart type
function getChartTypeDisplayName(chartType) {
    const chartNames = {
        'spending_breakdown': 'spending breakdown',
        'income_breakdown': 'income breakdown',
        'savings_trends': 'savings trends',
        'monthly_trends': 'monthly trends'
    };
    return chartNames[chartType] || 'chart data';
}

// Get display name for date range
function getDateRangeDisplayName(dateRange) {
    const rangeNames = {
        'last_3_months': 'last 3 months',
        'last_6_months': 'last 6 months',
        'last_12_months': 'last 12 months',
        'current_year': 'current year'
    };
    return rangeNames[dateRange] || 'selected period';
}

// Load main chart based on dashboard's current period
async function loadMainChart() {
    const loadingDiv = document.getElementById('ai-loading');
    const contentDiv = document.getElementById('ai-insights-content');
    const chartContainer = document.getElementById('main-chart-container');

    loadingDiv.style.display = 'block';
    contentDiv.style.display = 'none';

    try {
        // Build query parameters using dashboard's current period dates
        // These values are passed from the Django view context
        const dashboardStartDate = '{{ start_date|date:"Y-m-d" }}';
        const dashboardEndDate = '{{ end_date|date:"Y-m-d" }}';
        const periodDisplay = '{{ period_display }}';

        let params = new URLSearchParams();
        params.append('chart_type', currentMainChartType);
        params.append('date_range', 'custom');
        params.append('start_date', dashboardStartDate);
        params.append('end_date', dashboardEndDate);

        const response = await fetch(`/user/api/comprehensive-chart-data/?${params.toString()}`);
        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        // Update chart summary with actual data and dashboard period
        if (data.data[currentMainChartType] && data.data[currentMainChartType].summary) {
            const summary = data.data[currentMainChartType].summary;
            document.getElementById('mainChartSummary').textContent =
                `Showing ${getChartTypeDisplayName(currentMainChartType)} for "${periodDisplay}" (Total: â‚¹${parseFloat(summary.total_amount || 0).toLocaleString()})`;
        } else {
            // Fallback summary if no data available
            document.getElementById('mainChartSummary').textContent =
                `Showing ${getChartTypeDisplayName(currentMainChartType)} for "${periodDisplay}"`;
        }

        // Render appropriate chart
        renderMainChart(data.data);

        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';

    } catch (error) {
        console.error('Error loading main chart:', error);
        loadingDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                Unable to load chart data. Please try again later.
                <br><small class="text-muted">Error: ${error.message}</small>
            </div>
        `;
    }
}

// Render the appropriate chart based on type
function renderMainChart(data) {
    const container = document.getElementById('main-chart-container');

    if (currentMainChartType === 'spending_breakdown') {
        renderSpendingBreakdownChart(data.spending_breakdown);
    } else if (currentMainChartType === 'income_breakdown') {
        renderIncomeBreakdownChart(data.income_breakdown);
    } else if (currentMainChartType === 'savings_trends') {
        renderSavingsTrendsChart(data.savings_trends);
    } else if (currentMainChartType === 'monthly_trends') {
        renderMonthlyTrendsChart(data.monthly_trends);
    }
}

// Render spending breakdown chart (doughnut)
function renderSpendingBreakdownChart(data) {
    const container = document.getElementById('main-chart-container');

    if (!data || !data.analysis || data.analysis.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                <p class="text-muted">No expense data available for the selected period</p>
                <small class="text-muted">Try selecting a different time period</small>
            </div>
        `;
        return;
    }

    const labels = data.analysis.map(item => item.category_display);
    const values = data.analysis.map(item => parseFloat(item.total_amount));
    const backgroundColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
    ];

    container.innerHTML = `
        <div style="position: relative; height: 400px; width: 100%;">
            <canvas id="mainSpendingChart"></canvas>
        </div>
    `;

    const ctx = document.getElementById('mainSpendingChart').getContext('2d');

    // Destroy existing chart if it exists
    if (window.mainChart && typeof window.mainChart.destroy === 'function') {
        window.mainChart.destroy();
    }

    window.mainChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: backgroundColors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const value = context.parsed || 0;
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${context.label}: â‚¹${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Render income breakdown chart (doughnut)
function renderIncomeBreakdownChart(data) {
    const container = document.getElementById('main-chart-container');

    if (!data || !data.analysis || data.analysis.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                <p class="text-muted">No income data available for the selected period</p>
                <small class="text-muted">Try selecting a different time period</small>
            </div>
        `;
        return;
    }

    const labels = data.analysis.map(item => item.category_display);
    const values = data.analysis.map(item => parseFloat(item.total_amount));
    const backgroundColors = [
        '#4CAF50', '#2196F3', '#FF9800', '#9C27B0',
        '#F44336', '#607D8B', '#795548', '#E91E63'
    ];

    container.innerHTML = `
        <div style="position: relative; height: 400px; width: 100%;">
            <canvas id="mainIncomeChart"></canvas>
        </div>
    `;

    const ctx = document.getElementById('mainIncomeChart').getContext('2d');

    // Destroy existing chart if it exists
    if (window.mainChart && typeof window.mainChart.destroy === 'function') {
        window.mainChart.destroy();
    }

    window.mainChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: backgroundColors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const value = context.parsed || 0;
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${context.label}: â‚¹${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Render savings trends chart (line chart)
function renderSavingsTrendsChart(data) {
    const container = document.getElementById('main-chart-container');

    if (!data || !data.monthly_data || data.monthly_data.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <p class="text-muted">No savings data available for the selected period</p>
                <small class="text-muted">Try selecting a different time period</small>
            </div>
        `;
        return;
    }

    const labels = data.monthly_data.map(item => item.month_display);
    const savingsData = data.monthly_data.map(item => parseFloat(item.savings));
    const incomeData = data.monthly_data.map(item => parseFloat(item.income));
    const expensesData = data.monthly_data.map(item => parseFloat(item.expenses));

    container.innerHTML = `
        <div style="position: relative; height: 400px; width: 100%;">
            <canvas id="mainSavingsChart"></canvas>
        </div>
    `;

    const ctx = document.getElementById('mainSavingsChart').getContext('2d');

    // Destroy existing chart if it exists
    if (window.mainChart && typeof window.mainChart.destroy === 'function') {
        window.mainChart.destroy();
    }

    window.mainChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Monthly Savings',
                    data: savingsData,
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Income',
                    data: incomeData,
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4,
                    hidden: true
                },
                {
                    label: 'Expenses',
                    data: expensesData,
                    borderColor: '#F44336',
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    tension: 0.4,
                    hidden: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y || 0;
                            return `${context.dataset.label}: â‚¹${value.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'â‚¹' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Render monthly trends chart (bar chart)
function renderMonthlyTrendsChart(data) {
    const container = document.getElementById('main-chart-container');

    if (!data || !data.monthly_data || data.monthly_data.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                <p class="text-muted">No monthly data available for the selected period</p>
                <small class="text-muted">Try selecting a different time period</small>
            </div>
        `;
        return;
    }

    const labels = data.monthly_data.map(item => item.month_display);
    const incomeData = data.monthly_data.map(item => parseFloat(item.income));
    const expensesData = data.monthly_data.map(item => parseFloat(item.expenses));
    const balanceData = data.monthly_data.map(item => parseFloat(item.balance));

    container.innerHTML = `
        <div style="position: relative; height: 400px; width: 100%;">
            <canvas id="mainMonthlyChart"></canvas>
        </div>
    `;

    const ctx = document.getElementById('mainMonthlyChart').getContext('2d');

    // Destroy existing chart if it exists
    if (window.mainChart && typeof window.mainChart.destroy === 'function') {
        window.mainChart.destroy();
    }

    window.mainChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Income',
                    data: incomeData,
                    backgroundColor: 'rgba(76, 175, 80, 0.6)',
                    borderColor: '#4CAF50',
                    borderWidth: 1
                },
                {
                    label: 'Expenses',
                    data: expensesData,
                    backgroundColor: 'rgba(244, 67, 54, 0.6)',
                    borderColor: '#F44336',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y || 0;
                            return `${context.dataset.label}: â‚¹${value.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'â‚¹' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Advanced Filters Functions
function clearAdvancedFilters() {
    // Clear month selector
    const monthSelector = document.getElementById('monthSelector');
    if (monthSelector) {
        monthSelector.value = '';
    }

    // Clear date inputs
    const startDateInput = document.getElementById('start-date-input');
    const endDateInput = document.getElementById('end-date-input');

    if (startDateInput) startDateInput.value = '';
    if (endDateInput) endDateInput.value = '';

    // Submit the form with cleared filters
    const form = document.getElementById('advancedFiltersForm');
    if (form) {
        form.submit();
    } else {
        // Fallback: redirect to dashboard without parameters
        window.location.href = '/user/dashboard/';
    }
}

// Auto-submit form when month is selected (now using the unified form)
document.addEventListener('DOMContentLoaded', function() {
    const monthSelector = document.getElementById('monthSelector');
    if (monthSelector) {
        monthSelector.addEventListener('change', function() {
            // If a month is selected, clear the date inputs to avoid conflicts
            if (this.value) {
                const startDateInput = document.getElementById('start-date-input');
                const endDateInput = document.getElementById('end-date-input');
                if (startDateInput) startDateInput.value = '';
                if (endDateInput) endDateInput.value = '';
            }

            // Submit the unified form
            const form = document.getElementById('advancedFiltersForm');
            if (form) {
                form.submit();
            }
        });
    }
});

// Auto-refresh AI insights every 5 minutes
setInterval(function() {
    if (document.visibilityState === 'visible') {
        loadAIInsights();
    }
}, 300000);
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </h1>
    </div>
</div>

<!-- Filter Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter"></i> View Period: {{ period_display }}
                </h5>
            </div>
            <div class="card-body">
                <!-- Quick Period Buttons -->
                <div class="btn-group mb-3" role="group" aria-label="Period Filter">
                    <a href="?period=current_month" class="btn {% if selected_period == 'current_month' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="fas fa-calendar-day"></i> This Month
                    </a>
                    <a href="?period=last_year" class="btn {% if selected_period == 'last_year' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="fas fa-calendar-alt"></i> Last Year
                    </a>
                </div>

                <!-- Advanced Filters -->
                <form method="get" id="advancedFiltersForm" class="row g-3 align-items-end">
                    <div class="col-lg-4 col-md-6">
                        <div class="d-flex flex-column">
                            <label class="form-label fw-bold small mb-2 text-muted">Quick Select Month:</label>
                            <select class="form-select form-select-sm" name="month" id="monthSelector">
                                <option value="">Choose Month...</option>
                                {% for month in available_months %}
                                    <option value="{{ month.value }}" {% if selected_month == month.value %}selected{% endif %}>
                                        {{ month.label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-8 col-md-6">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="d-flex flex-column">
                                    <label class="form-label fw-bold small mb-2 text-muted">From Date:</label>
                                    <input type="date" class="form-control form-control-sm" name="start_date" value="{{ custom_start_date }}" id="start-date-input">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex flex-column">
                                    <label class="form-label fw-bold small mb-2 text-muted">To Date:</label>
                                    <input type="date" class="form-control form-control-sm" name="end_date" value="{{ custom_end_date }}" id="end-date-input">
                                </div>
                            </div>
                            <div class="col-md-4 d-flex flex-column">
                                <label class="form-label fw-bold small mb-2 opacity-0">Actions:</label>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success btn-sm flex-fill" id="applyFiltersBtn">
                                        <i class="fas fa-search"></i> Apply
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAdvancedFilters()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                                                <small class="text-muted d-block mt-2">
                    Showing data from {{ start_date|date:"M j, Y" }} to {{ end_date|date:"M j, Y" }}
                    <br>{{ period_display }} - {{ recent_transactions|length }} transactions shown ({{ filtered_transactions.count }} total in period)
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Financial Overview Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">
                            <i class="fas fa-arrow-up"></i> Income
                        </h5>
                        <h3 class="mb-0">â‚¹{{ total_income|floatformat:2 }}</h3>
                        <small>{{ period_display }}</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-coins fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">
                            <i class="fas fa-arrow-down"></i> Expenses
                        </h5>
                        <h3 class="mb-0">â‚¹{{ total_expense|floatformat:2 }}</h3>
                        <small>{{ period_display }}</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-receipt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card {% if balance >= 0 %}bg-primary{% else %}bg-warning{% endif %} text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">
                            <i class="fas fa-balance-scale"></i>
                            {% if balance >= 0 %}Balance{% else %}Deficit{% endif %}
                        </h5>
                        <h3 class="mb-0">â‚¹{{ balance|floatformat:2 }}</h3>
                        <small>{{ period_display }}</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-wallet fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Daily Breakdown -->
{% if daily_data %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-check"></i> Daily Expenses & Income ({{ period_display }})
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Income</th>
                                <th>Expenses</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in daily_data %}
                            <tr>
                                <td>{{ day.date }}</td>
                                <td class="text-success">â‚¹{{ day.income|floatformat:2 }}</td>
                                <td class="text-danger">â‚¹{{ day.expense|floatformat:2 }}</td>
                                <td class="{% if day.income|add:day.expense >= 0 %}text-primary{% else %}text-warning{% endif %}">
                                    â‚¹{{ day.income|add:day.expense|floatformat:2 }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}



<div class="row">
    <!-- Recent Transactions -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history"></i> Recent Transactions
                </h5>
                <a href="{% url 'user:transaction_list' %}" class="btn btn-sm btn-outline-primary">
                    View All
                </a>
            </div>
            <div class="card-body">
                {% if recent_transactions %}
                    <div class="list-group list-group-flush">
                        {% for transaction in recent_transactions %}
                        <div class="list-group-item border-0 px-0 py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <span class="badge bg-{% if transaction.transaction_type == 'income' %}success{% else %}danger{% endif %}">
                                            <i class="fas fa-{% if transaction.transaction_type == 'income' %}plus{% else %}minus{% endif %}"></i>
                                        </span>
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ transaction.get_category_display }}</div>
                                        <small class="text-muted">{{ transaction.date|date:"M j, Y" }} â€¢ {{ transaction.description|truncatechars:20 }}</small>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-{% if transaction.transaction_type == 'income' %}success{% else %}danger{% endif %}">
                                        {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}â‚¹{{ transaction.amount|floatformat:0 }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No transactions yet</h6>
                        <p class="text-muted mb-3">Start by adding your first transaction</p>
                        <a href="{% url 'user:add_transaction' %}" class="btn btn-primary btn-sm">
                            Add Transaction
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Budget Overview -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie"></i> Budget Overview
                </h5>
                <a href="{% url 'user:budget_management' %}" class="btn btn-sm btn-outline-primary">
                    Manage
                </a>
            </div>
            <div class="card-body">
                <!-- Overall Budget Usage -->
                {% if total_budgeted > 0 %}
                <div class="mb-3 p-2 bg-light rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Total Budget Usage</span>
                        <div class="d-flex align-items-center">
                            <span class="badge {% if overall_budget_usage > 90 %}bg-danger{% elif overall_budget_usage > 75 %}bg-warning{% else %}bg-success{% endif %} me-2">
                                {{ overall_budget_usage|floatformat:1 }}%
                            </span>
                            <small class="text-muted">
                                <i class="fas fa-magic" title="Auto-adjustment enabled"></i>
                            </small>
                        </div>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar {% if overall_budget_usage > 90 %}bg-danger{% elif overall_budget_usage > 75 %}bg-warning{% else %}bg-success{% endif %}"
                             role="progressbar"
                             style="width: {{ overall_budget_usage }}%">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between text-sm">
                        <span>Total Budgeted: â‚¹{{ total_budgeted|floatformat:2 }}</span>
                        <span>Available: â‚¹{{ available_for_budget|floatformat:2 }}</span>
                    </div>
                    <div class="mt-2">
                        {% comment %} <small class="text-info">
                            <i class="fas fa-info-circle"></i>
                            Budgets are automatically adjusted when you spend on unbudgeted categories
                        </small> {% endcomment %}
                    </div>
                </div>
                {% endif %}
                {% if budgets %}
                    {% for budget in budgets %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold">{{ budget.category_display }}</span>
                            <div class="text-end">
                                <small class="text-muted">â‚¹{{ budget.current_expenses|default:0 }} / â‚¹{{ budget.amount }}</small>
                                {% if budget.is_over_budget %}
                                    <i class="fas fa-exclamation-triangle text-danger ms-1" title="Over Budget"></i>
                                {% endif %}
                            </div>
                        </div>
                        <div class="progress mt-1" style="height: 8px;">
                            <div class="progress-bar {% if budget.is_over_budget %}bg-danger{% elif budget.usage_percentage > 80 %}bg-warning{% else %}bg-success{% endif %}"
                                 role="progressbar"
                                 style="width: {{ budget.usage_percentage }}%">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">
                                {% if budget.is_over_budget %}
                                    Over by â‚¹{{ budget.over_budget_amount|floatformat:2 }}
                                {% else %}
                                    â‚¹{{ budget.remaining_budget|floatformat:2 }} remaining
                                {% endif %}
                            </small>
                            <a href="{% url 'user:budget_management' %}?edit={{ budget.category }}&month={{ budget.month|date:'Y-m' }}"
                               class="btn btn-sm btn-outline-primary py-0 px-2">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-chart-pie fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-2">No budgets set</p>
                        <a href="{% url 'user:budget_management' %}" class="btn btn-primary btn-sm">
                            Create Your First Budget
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- AI Insights and Analytics -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-brain"></i> AI Financial Insights
                </h5>
            </div>
            <div class="card-body">
                <!-- Chart Type Selector -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-primary">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-5">
                                        <label for="mainChartTypeSelect" class="form-label fw-bold">
                                            <i class="fas fa-chart-line"></i> AI Chart Type
                                        </label>
                                        <select class="form-select" id="mainChartTypeSelect" onchange="onMainChartTypeChange()">
                                            <option value="spending_breakdown">ðŸ’° Spending Breakdown</option>
                                            <option value="income_breakdown">ðŸ’µ Income Breakdown</option>
                                            <option value="savings_trends">ðŸ“ˆ Savings Trends</option>
                                            <option value="monthly_trends">ðŸ“Š Monthly Trends</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="alert alert-info py-2 mb-0">
                                            <small class="mb-0">
                                                <i class="fas fa-sync"></i> <strong>AI Charts synchronized with dashboard period:</strong>
                                                <br>{{ period_display }} ({{ start_date|date:"M j, Y" }} - {{ end_date|date:"M j, Y" }})
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary flex-fill" onclick="loadMainChart()">
                                                <i class="fas fa-sync"></i> Refresh
                                            </button>
                                            <!-- <button class="btn btn-outline-info" onclick="loadBudgetSuggestions()">
                                                <i class="fas fa-lightbulb"></i> AI Tips
                                            </button> -->
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">
                                            <span id="mainChartSummary">Showing spending breakdown for "{{ period_display }}"</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div id="ai-loading" class="text-center py-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading chart data...</p>
                </div>

                <!-- AI Insights Content -->
                <div id="ai-insights-content">
                    <!-- Main Chart -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div id="main-chart-container">
                                <!-- Chart will be dynamically loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Smart Suggestions -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-center"><i class="fas fa-lightbulb"></i> Smart Budget Suggestions</h6>
                            <div id="budget-suggestions" class="d-flex justify-content-center align-items-center min-vh-10">
                                <div class="text-center py-5 px-4 bg-light rounded-3 w-75">
                                    <small class="text-muted fs-6">Click "AI Tips" to get AI-powered budget recommendations and spending suggestions</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}
